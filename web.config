<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <!-- Enable static file caching for better performance -->
    <staticContent>
      <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="365.00:00:00" />
    </staticContent>

    <!-- URL Rewrite Module for routing sub-paths to respective applications -->
    <rewrite>
      <rules>
        <!-- Route /manage/* to LMS_admin application -->
        <rule name="Rewrite manage to LMS_admin" stopProcessing="true">
          <match url="^manage/?(.*)" ignoreCase="true" />
          <action type="Rewrite" url="LMS_admin/{R:1}" />
        </rule>

        <!-- Route /learn/* to LMS_learner application -->
        <rule name="Rewrite learn to LMS_learner" stopProcessing="true">
          <match url="^learn/?(.*)" ignoreCase="true" />
          <action type="Rewrite" url="LMS_learner/{R:1}" />
        </rule>

        <!-- Redirect root to learner application -->
        <rule name="Redirect root to learner" stopProcessing="true">
          <match url="^$" />
          <action type="Redirect" url="/learn/" redirectType="Permanent" />
        </rule>

        <!-- Remove trailing slash for clean URLs -->
        <rule name="Remove trailing slash" stopProcessing="false">
          <match url=".*/$" />
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
          </conditions>
          <action type="Redirect" url="{R:0}" redirectType="Permanent" />
        </rule>
      </rules>

      <!-- Allow outbound rules for proper response rewriting -->
      <outboundRules>
        <!-- Rewrite Set-Cookie paths for /manage -->
        <rule name="Update Set-Cookie for manage">
          <match serverVariable="RESPONSE_SET_COOKIE" pattern="^(.*)Path=/(.*)$" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/manage" />
          </conditions>
          <action type="Rewrite" value="{R:1}Path=/manage/{R:2}" />
        </rule>

        <!-- Rewrite Set-Cookie paths for /learn -->
        <rule name="Update Set-Cookie for learn">
          <match serverVariable="RESPONSE_SET_COOKIE" pattern="^(.*)Path=/(.*)$" />
          <conditions>
            <add input="{REQUEST_URI}" pattern="^/learn" />
          </conditions>
          <action type="Rewrite" value="{R:1}Path=/learn/{R:2}" />
        </rule>
      </outboundRules>
    </rewrite>

    <!-- Request filtering for security -->
    <security>
      <requestFiltering>
        <fileExtensions>
          <add fileExtension=".config" allowed="false" />
          <add fileExtension=".exe" allowed="false" />
          <add fileExtension=".dll" allowed="false" />
        </fileExtensions>
      </requestFiltering>
    </security>

    <!-- HttpPlatformHandler for .NET Core applications -->
    <handlers>
      <add name="aspNetCore" path="*" verb="*" modules="AspNetCoreModule" resourceType="Unspecified" />
    </handlers>

    <!-- Application pool settings -->
    <applicationPool maxProcesses="1" />
  </system.webServer>

  <!-- Application settings -->
  <appSettings>
    <add key="ASPNETCORE_ENVIRONMENT" value="Production" />
  </appSettings>

  <!-- Logging -->
  <system.diagnostics>
    <trace autoflush="true">
      <listeners>
        <add name="aspNetCoreModule" type="System.Diagnostics.TextWriterTraceListener" initializeData=".\logs\aspnetcore.txt" />
      </listeners>
    </trace>
  </system.diagnostics>
</configuration>
